<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Firmware Hacking - NSE Lab</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Firmware Hacking | NSE Lab</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Firmware Hacking" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Documentation for the Division of Network and Systems Engineering’s Cyber Security Lab at KTH" /> <meta property="og:description" content="Documentation for the Division of Network and Systems Engineering’s Cyber Security Lab at KTH" /> <link rel="canonical" href="http://localhost:4000/pages/guides/firmware/firmware_hacking.html" /> <meta property="og:url" content="http://localhost:4000/pages/guides/firmware/firmware_hacking.html" /> <meta property="og:site_name" content="NSE Lab" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Firmware Hacking" /> <script type="application/ld+json"> {"headline":"Firmware Hacking","description":"Documentation for the Division of Network and Systems Engineering’s Cyber Security Lab at KTH","@type":"WebPage","url":"http://localhost:4000/pages/guides/firmware/firmware_hacking.html","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"> NSE Lab </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/pages/thesis_guidelines/guidelines.html" class="nav-list-link">Thesis Guidelines</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/registration.html" class="nav-list-link">Registration</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/objective.html" class="nav-list-link">Objective</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/choice_of_system.html" class="nav-list-link">Choice of System to Explore</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/things_to_hack.html" class="nav-list-link">Things to hack</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/purchase_form.html" class="nav-list-link">Purchase Form</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/delimitations.html" class="nav-list-link">Delimitations</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/method.html" class="nav-list-link">Method</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/theory.html" class="nav-list-link">Theory</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/related_work.html" class="nav-list-link">Related work</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/thesis_report.html" class="nav-list-link">Thesis Report</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/threat_traceability_matrix.html" class="nav-list-link">Threat Traceability Matrix</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/grading_criteria.html" class="nav-list-link">Grading criteria</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/language.html" class="nav-list-link">Language</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/tutoring.html" class="nav-list-link">Tutoring</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/responsible_disclosure.html" class="nav-list-link">Responsible disclosure</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/the_law.html" class="nav-list-link">The Law</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/thesis_guidelines/lab.html" class="nav-list-link">Cyber Security Lab</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/pages/guides/hacking_guides.html" class="nav-list-link">Hacking Guides</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/pages/guides/pentest-process-planning.html" class="nav-list-link">Planning</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/guides/pentest-process-exploit.html" class="nav-list-link">Exploitation</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/guides/pentest-process-report.html" class="nav-list-link">Reporting</a></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/pages/guides/Wireless/wireless.html" class="nav-list-link">Wireless Hacking</a><ul class="nav-list"><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Wireless/wireshark.html" class="nav-list-link">Wireshark</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Wireless/wifi-mitm.html" class="nav-list-link">Wi-Fi MITM</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Wireless/bluetooth.html" class="nav-list-link">Bluetooth</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Wireless/lte-hacking.html" class="nav-list-link">Overview of LTE Hacking</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Wireless/soho-device_exploitation.html" class="nav-list-link">SOHO Device Exploitation</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Wireless/ubertooth.html" class="nav-list-link">Ubertooth One</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Wireless/arp-spoofing.html" class="nav-list-link">ARP Spoofing and MitM attacks</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/pages/guides/hardware/hardware.html" class="nav-list-link">Hardware Hacking</a><ul class="nav-list"><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/hardware/uart.html" class="nav-list-link">0x01 - Analyzing UART</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/hardware/i2c.html" class="nav-list-link">0x02 - Analyzing I2C</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/hardware/spi.html" class="nav-list-link">0x03 - Analyzing SPI</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/hardware/jtag.html" class="nav-list-link">0x04 - Analyzing JTAG</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/hardware/emmc.html" class="nav-list-link">0x05 - Analyzing eMMC</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/hardware/hardware_hacking.html" class="nav-list-link">0x06 - Useful links and tutorials</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/pages/guides/radio/radio.html" class="nav-list-link">Radio Hacking</a><ul class="nav-list"><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/radio/sdr.html" class="nav-list-link">0x01 - Analyzing SDR</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/radio/zigbee.html" class="nav-list-link">0x02 - Analyzing ZigBee</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/radio/ble.html" class="nav-list-link">0x03 - Analyzing BLE</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/radio/hackrf.html" class="nav-list-link">HackRF One</a> </li></ul></li><li class="nav-list-item active"><a href="http://localhost:4000/pages/guides/firmware/firmware_hacking.html" class="nav-list-link active">Firmware Hacking</a></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/pages/guides/fuzzing/fuzzing.html" class="nav-list-link">Fuzzing</a><ul class="nav-list"><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/fuzzing/introduction.html" class="nav-list-link">Introduction to Clusterfuzz</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/fuzzing/configuring-clusterfuzz.html" class="nav-list-link">Configuring the lab's Clusterfuzz service</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/fuzzing/start-stop.html" class="nav-list-link">Start/stop the Service</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/pages/guides/web/web.html" class="nav-list-link">Web Hacking</a><ul class="nav-list"><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/injection.html" class="nav-list-link">0x01 - Injection Attacks</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/authentication.html" class="nav-list-link">0x02 - Broken Authentication</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/sensitive-exposure.html" class="nav-list-link">0x03 - Sensitive Data Exposure</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/xxe.html" class="nav-list-link">0x04 - XML External Entities (XXE)</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/access-control.html" class="nav-list-link">0x05 - Broken Access Control</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/security-misconfiguration.html" class="nav-list-link">0x06 - Security Misconfiguration</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/xss.html" class="nav-list-link">0x07 - Cross Site Scripting (XSS)</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/insecure-deserialization.html" class="nav-list-link">0x08 - Insecure Deserialization</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/components.html" class="nav-list-link">0x09 - Using Components with Known Vulnerabilities</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/logging-and-monitoring.html" class="nav-list-link">0x10 - Insufficient Logging and Monitoring</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/web/http-request-smuggling.html" class="nav-list-link">0x11 - HTTP Request Smuggling</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/pages/guides/Creating%20threat%20models/Creating%20Threat%20Models.html" class="nav-list-link">Creating Threat Models</a><ul class="nav-list"><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Creating%20threat%20models/Prerequisites.html" class="nav-list-link">Prerequisites</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Creating%20threat%20models/MAL.html" class="nav-list-link">MAL</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Creating%20threat%20models/securiCAD.html" class="nav-list-link">securiCAD</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Creating%20threat%20models/DSL.html" class="nav-list-link">DSL</a> </li><li class="nav-list-item "> <a href="http://localhost:4000/pages/guides/Creating%20threat%20models/coreLang.html" class="nav-list-link">coreLang</a> </li></ul></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/pages/lab-equipment/lab-equipment.html" class="nav-list-link">Lab Equipment</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/pages/lab-equipment/iot-devices.html" class="nav-list-link">IoT Devices</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/lab-equipment/hacking-tools.html" class="nav-list-link">Hacking Tools</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/lab-equipment/computers.html" class="nav-list-link">Computers and hardware</a></li><li class="nav-list-item "><a href="http://localhost:4000/pages/lab-equipment/books.html" class="nav-list-link">Books</a></li></ul></li><li class="nav-list-item"><a href="http://localhost:4000/pages/previous-work.html" class="nav-list-link">Previous Work</a></li><li class="nav-list-item"><a href="http://localhost:4000/pages/contribute.html" class="nav-list-link">Contribute</a></li><li class="nav-list-item"><a href="http://localhost:4000/pages/feedback.html" class="nav-list-link">Feedback</a></li><li class="nav-list-item"><a href="http://localhost:4000/" class="nav-list-link">Home</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search NSE Lab" aria-label="Search NSE Lab" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/pages/guides/hacking_guides.html">Hacking Guides</a></li> <li class="breadcrumb-nav-list-item"><span>Firmware Hacking</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="firmware-reversing-methodology"> <a href="#firmware-reversing-methodology" class="anchor-heading" aria-labelledby="firmware-reversing-methodology"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Firmware Reversing Methodology </h1> <h2 id="1-pentest-objectives"> <a href="#1-pentest-objectives" class="anchor-heading" aria-labelledby="1-pentest-objectives"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Pentest objectives </h2> <ul> <li>Sensitive data exposure</li> <li>Update mechanism to capture firmware</li> <li>Local data storage</li> <li>Vulnerabilities <em>(i.e. buffer overflow)</em> to bypass authentication and <em>(i.e. command injection)</em> to RCE</li> <li>Security configuration</li> </ul> <h2 id="2-tools"> <a href="#2-tools" class="anchor-heading" aria-labelledby="2-tools"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Tools </h2> <ul> <li><a href="https://github.com/ReFirmLabs/binwalk">Binwalk firmware analysis tool</a> <ul> <li>Binwalk is an open source tool for extracting, analyzing, and reverse engineering firmware images</li> <li>It scans the image for known file type signatures <ul> <li>compressed streams</li> <li>embedded file systems</li> </ul> </li> <li>Most tools depend on binwalk</li> </ul> </li> <li><a href="https://github.com/attify/firmware-analysis-toolkit">Firmware Analysis Toolkit</a></li> <li><a href="https://gitlab.com/bytesweep/bytesweep">Automated scanner</a></li> <li><a href="https://github.com/craigz28/firmwalker">Firmwalker</a></li> <li><a href="https://github.com/armijnhemel/binaryanalysis-ng">Binary Analysis Next Generation</a></li> <li><a href="https://github.com/firmadyne/firmadyne">Firmadyne</a></li> <li><a href="https://github.com/fkie-cad/FACT_core">Firmware Analysis Comparison Toolkit</a></li> <li><a href="https://github.com/rampageX/firmware-mod-kit">Firmware mod kit</a></li> <li><a href="https://github.com/angr/angr">Angr binary analysis framework</a></li> <li><a href="https://github.com/frida/frida">Frida</a></li> <li><a href="https://github.com/radareorg/radare2">Radare2</a></li> <li><a href="https://www.qemu.org/download/">QEMU</a></li> </ul> <h2 id="3-firmware-update"> <a href="#3-firmware-update" class="anchor-heading" aria-labelledby="3-firmware-update"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Firmware update </h2> <ul> <li>Four techniques are common to get firmware <ul> <li>download the corresponding version of the firmware from the device manufacturer’s website</li> <li>search in <em>Google</em> and check it out in <em>GitHub</em></li> <li>sniff the OTA <em>(over-the-air)</em> to get the firmware binary while the device is performing an update</li> <li>reverse the mobile app to understand how to get the firmware binary</li> <li>and dump the firmware from the device’s <em>UART</em> or <em>JTAG</em> or flash chip</li> </ul> </li> <li>An attacker could intercept firmware when it is downloaded for updating device <ul> <li>Unencrypted HTTP traffic is intercepted via a transparent proxy <em>(Burp Suite)</em></li> <li>HTTPS traffic can be captured only if it is possible to <em>MitM</em> <em>(arpspoof + mitmproxy + Burp)</em></li> </ul> </li> <li>Firstly, all states that trigger OTA update for device/hub firmware is identified <ul> <li>In general, device firmware is updated via mobile app <ul> <li>in this case the traffic between smartphone and cloud service is intercepted</li> </ul> </li> <li>In addition, hub can trigger OTA update either for itself or for the device <ul> <li>in this case the traffic between hub and cloud service is intercepted</li> </ul> </li> <li>Moreover, a local update (rather than OTA) via an SD card sometimes is available <ul> <li>this vulnerability is related to attack surface of device physical interface</li> </ul> </li> </ul> </li> <li>If the vendor only transmits update partition, <ul> <li>although full-firmware is not obtained,</li> <li>most probably sensitive data can be accessed</li> <li>this will affect severity to a lower level</li> </ul> </li> <li>Reference <ol> <li>https://resources.sei.cmu.edu/library/asset-view.cfm?assetID=453871</li> </ol> </li> </ul> <h2 id="4-firmware-file-analysis"> <a href="#4-firmware-file-analysis" class="anchor-heading" aria-labelledby="4-firmware-file-analysis"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Firmware file analysis </h2> <ul> <li>A standard firmware binary image has four parts. Respectively, <ul> <li>bin header</li> <li>firmware header</li> <li>compressed data</li> <li>file system</li> </ul> </li> <li>More precisely, <ul> <li>a bootloader <em>(i.e. U-Boot, Barebox, RedBoot)</em></li> <li>kernel</li> <li>some kind of compressed data <em>(i.e. LZMA, Gzip, zip, zlib)</em></li> <li>a file system <em>(i.e. Squash FS, Cramfs, JFFS2, YAFFS2, ext2)</em></li> </ul> </li> <li>The <em>root</em> folder in file system contains <ul> <li>all binaries</li> <li>scripts and source code</li> <li>configurations</li> <li>and data <em>(credentials, ssh keys, etc.)</em></li> <li>NOTE: The root folder might have additional file system images inside</li> </ul> </li> </ul> <h2 id="5-filesystem-extraction"> <a href="#5-filesystem-extraction" class="anchor-heading" aria-labelledby="5-filesystem-extraction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. Filesystem extraction </h2> <ul> <li> <p>Method 1 - Binwalk (automated)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>binwalk -t &lt;firmware-image&gt;
binwalk -e &lt;firmware-image&gt;
</code></pre></div> </div> </li> <li>Method 2 - Firmware mod kit <ul> <li>set <code class="language-plaintext highlighter-rouge">BINWALK</code> in <code class="language-plaintext highlighter-rouge">shared-ng.config</code> to the path of binwalk</li> <li> <p>copy the firmware inside the <code class="language-plaintext highlighter-rouge">firmware-mod-kit/</code> directory</p> <p><code class="language-plaintext highlighter-rouge">./extract-firmware.sh &lt;firmware-image-file&gt;</code></p> </li> </ul> </li> <li>If binwalk cannot decompress the filesystem using the <code class="language-plaintext highlighter-rouge">-e</code> switch, try other alternatives <ul> <li> <p>Try specific tools, i.e. <code class="language-plaintext highlighter-rouge">unsquashfs</code></p> </li> <li> <p>Sometimes files are not stored in a file system but exist as a plain flash binary file</p> </li> <li>Firmware may be a proprietary with a modified and unknown file system and sections <ul> <li>when binwalk generates false positives</li> <li><em>manually</em> extract using binwalk (help binwalk by tuning parameters)</li> </ul> </li> <li>The firmware may be encrypted, confirm this with entropy analysis <ul> <li> <p>when binwalk fails to identify any specific section</p> <p><code class="language-plaintext highlighter-rouge">binwalk -E &lt;firmware-image&gt;</code></p> </li> <li>high entropy with a bit of variation indicates compression</li> <li>high entropy with flat line indicates encrypted content</li> <li>need to identify the encryption method and keys</li> <li><em>XOR</em> encryption <ul> <li> <p>key is identified by recurring strings</p> <p><code class="language-plaintext highlighter-rouge">cat encrypted.bin | python decryptxor.py &gt; decrypted.bin</code></p> </li> </ul> </li> </ul> </li> <li>If it is not possible to extract data, try hardware-based extraction <ul> <li>https://www.youtube.com/watch?v=0G2g-tLMK70</li> </ul> </li> </ul> </li> </ul> <h2 id="6-filesystem-analysis"> <a href="#6-filesystem-analysis" class="anchor-heading" aria-labelledby="6-filesystem-analysis"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6. Filesystem analysis </h2> <ul> <li>Search for <em>“sensitive”</em> data from firmware <ul> <li>Hard-coded credentials <ul> <li>that users are unable to change</li> </ul> </li> <li>Default credentials <ul> <li>that users rarely change</li> </ul> </li> <li>Backdoor access credentials <ul> <li>that is designed to be used for customer support</li> </ul> </li> <li>Hash and private certificates</li> <li>Encryption algorithms with keys</li> <li>API keys and access tokens</li> <li>Update or staging URLs</li> <li>Local path names and environment details</li> <li>Authentication and Authorization mechanisms</li> <li>Replace user/password and/or create new password</li> </ul> </li> <li> <p>Sample search queries</p> <p><code class="language-plaintext highlighter-rouge">grep -inr 'telnet'</code></p> <p><code class="language-plaintext highlighter-rouge">firmware-analysis-toolki/firmwalker.sh &lt;firmware-root-dir&gt;</code></p> </li> </ul> <h2 id="7-static-binary-analysis"> <a href="#7-static-binary-analysis" class="anchor-heading" aria-labelledby="7-static-binary-analysis"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7. Static binary analysis </h2> <ul> <li> <p>Reversing libraries usually helps to find sensitive data</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>radare2 -a mips -b32 libdbox.so
  aaa
  afl
</code></pre></div> </div> <ul> <li> <p>grep for interesting strings</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>afl~wifi
afl~gen
afl~get
</code></pre></div> </div> </li> </ul> </li> <li> <p>Disassembly of sensitive functions helps to identify certain vulnerabilities</p> <ul> <li>command injection <ul> <li>use of unsanitized input may result in OS command execution</li> </ul> </li> <li>buffer overflow <ul> <li>use of insecure string handling functions such as <code class="language-plaintext highlighter-rouge">strcpy</code>, <code class="language-plaintext highlighter-rouge">strcat</code>, etc.,</li> <li>instead of their more secure <code class="language-plaintext highlighter-rouge">strncpy</code>, <code class="language-plaintext highlighter-rouge">strncat</code> counterparts,</li> <li>may result in buffer overflows</li> </ul> </li> </ul> </li> </ul> <h2 id="8-dynamic-binary-analysis"> <a href="#8-dynamic-binary-analysis" class="anchor-heading" aria-labelledby="8-dynamic-binary-analysis"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 8. Dynamic binary analysis </h2> <ul> <li> <p>Debug individual binaries in firmware to see if there are any vulnerabilities</p> </li> <li>Binary emulation <ul> <li> <p>Get binary architecture <em>(ARM, MIPS, PowerPC)</em></p> <p><code class="language-plaintext highlighter-rouge">readelf -f &lt;binary&gt;</code></p> </li> <li>Need to emulate binaries to run it in our analysis machine <ul> <li>install <em>qemu</em> (on our analysis box)</li> <li>copy qemu binary to the root folder of the firmware filesystem <ul> <li>qemu version should be compatible with the binary architecture</li> <li> <p>for example MIPS</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>which qemu-mipsel-static        
cp /usr/bin/qemu-mipsel-static .
</code></pre></div> </div> </li> </ul> </li> </ul> </li> <li> <p>Emulate binary (wrong way)</p> <p><code class="language-plaintext highlighter-rouge">./qemu-mipsel-static ./bin/&lt;individual binary&gt;</code></p> <ul> <li>will not run, because</li> <li>qemu tries to load required libraries from <code class="language-plaintext highlighter-rouge">/lib</code> directory of host</li> <li>but cannot find</li> <li>we need to say qemu to look for from <code class="language-plaintext highlighter-rouge">/lib</code> of firmware filesystem</li> <li>we need to change the working directory path in runtime via <code class="language-plaintext highlighter-rouge">chown</code></li> <li><code class="language-plaintext highlighter-rouge">chown firmware-fs-root-dir/ ./qemu-mipsel-static ./bin/&lt;individual binary&gt;</code></li> </ul> </li> <li> <p>Emulate binary (correct way)</p> <p><code class="language-plaintext highlighter-rouge">chown . ./qemu-mipsel-static ./bin/&lt;individual binary&gt;</code></p> </li> </ul> </li> <li>Firmware emulation <ul> <li>Advantages <ul> <li>to access all the individual binaries in the firmware image</li> <li>to hook a debugger to any specific binary and perform vulnerability research</li> <li>to perform remote exploitation research</li> <li>to perform network pentest on the firmware</li> <li>to perform web application pentest on the firmware</li> </ul> </li> <li>Challenges <ul> <li>firmware is designed to run on another architecture <ul> <li>bypass with QEMU</li> </ul> </li> <li>bootup process might require configurations and additional information from NVRAM <ul> <li>hook all the calls being made by the firmware to NVRAM and can fake the return values</li> </ul> </li> <li>firmware might be dependent on physical hardware components to run <ul> <li>no solution</li> </ul> </li> </ul> </li> <li>Full emulation <ul> <li>Firmware Analysis Toolkit (FAT) based on Firmadyne <ul> <li>an interactive script</li> <li>asks password which is <em>firmadyne</em></li> <li>sets up a network access</li> <li>then runs the firmware</li> <li> <p>now the network services on firmware is accessible via the assigned IP</p> </li> <li>copy the firmware in <code class="language-plaintext highlighter-rouge">firmware-analysis-toolkit/</code></li> <li> <p>in <code class="language-plaintext highlighter-rouge">firmadyne.config</code> file set <code class="language-plaintext highlighter-rouge">FIRMWARE_DIR</code> to <code class="language-plaintext highlighter-rouge">firmware-analysis-toolkit/</code></p> <p><code class="language-plaintext highlighter-rouge">python fat.py</code></p> </li> </ul> </li> </ul> </li> </ul> </li> </ul> <h2 id="9-firmware-backdooring-modifying-sensitive-data"> <a href="#9-firmware-backdooring-modifying-sensitive-data" class="anchor-heading" aria-labelledby="9-firmware-backdooring-modifying-sensitive-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 9. Firmware backdooring (Modifying sensitive data) </h2> <ul> <li> <p>Extract filesystem on firmware</p> </li> <li>Develop a <em>backdoor</em> (by Osanda Malith, <em>@OsandaMalith</em>) and compile it to run on specific architecture (i.e. MIPS) <ul> <li> <p>backdoor opens a port and connects it to a binary allowing to execute commands when interacting service</p> </li> <li> <p>compile programs for a different architecture than your analysis machine</p> <ul> <li> <p>cross-compiling toolchain <em>BuildRoot</em></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>install BuildRoot
make menuconfig
</code></pre></div> </div> </li> <li>navigate to the <em>Target Options</em> and change the <em>Target Architecture</em></li> <li>navigate to the <em>Toolchain</em>, select_ Build Cross GDB for Host_</li> <li> <p>save configuration</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">make</code></p> </li> <li> <p>compile <code class="language-plaintext highlighter-rouge">bindshell.c</code> with the <em>GCC for MIPS</em>, which was created by <em>BuildRoot</em></p> <p><code class="language-plaintext highlighter-rouge">./mipsel-buildroot-linux-uclibc-gcc bindshell.c -static - o bindshell</code></p> </li> <li>bindshell can be executed on MIPS now</li> </ul> </li> </ul> </li> <li> <p>Modify an <code class="language-plaintext highlighter-rouge">.sh</code> file in <code class="language-plaintext highlighter-rouge">/etc/init.d/</code> to place the backdoor path so it could be started automatically at bootup</p> </li> <li> <p>Recompile the firmware</p> <p><code class="language-plaintext highlighter-rouge">firmware-mod-kit/build-firmware.sh &lt;firmware-root-dir&gt;/ -nopad -min</code></p> <ul> <li>produces <code class="language-plaintext highlighter-rouge">new-firmware.bin</code> file</li> </ul> </li> <li>Then modified firmware is flashed to device <ul> <li> <p>test it by emulation before flashing</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python fat.py
nc &lt;emulated-IP&gt; &lt;backdoor-port&gt;
</code></pre></div> </div> </li> </ul> </li> </ul> <h2 id="10-firmware-diffing-bindiff"> <a href="#10-firmware-diffing-bindiff" class="anchor-heading" aria-labelledby="10-firmware-diffing-bindiff"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 10. Firmware diffing (bindiff) </h2> <h2 id="11-references"> <a href="#11-references" class="anchor-heading" aria-labelledby="11-references"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 11. References </h2> <ul> <li>https://www.refirmlabs.com/binwalk/</li> </ul> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">Division of Network and Systems Engineering | KTH</p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
